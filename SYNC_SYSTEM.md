# Система синхронизации - Этап 5

## Обзор

Реализована полнофункциональная система синхронизации блокчейна Bitcoin с поддержкой:
- Автоматической фоновой синхронизации
- Обработки реорганизаций блокчейна
- Кэширования для оптимизации запросов
- Мониторинга состояния синхронизации

## Новые компоненты

### 1. API Endpoints для синхронизации (`/api/sync`)

#### Получение статуса синхронизации
```http
GET /api/sync/status
```

Возвращает:
```json
{
  "is_syncing": false,
  "network_height": 850000,
  "db_height": 849990,
  "blocks_behind": 10,
  "sync_progress": 99.99,
  "is_synced": false,
  "stats": {
    "blocks_synced": 1000,
    "transactions_synced": 5000,
    "errors": 0,
    "last_sync_time": 1234567890.0,
    "sync_progress": 99.99
  }
}
```

#### Запуск синхронизации
```http
POST /api/sync/start?max_blocks=100
```

Запускает синхронизацию последних блоков (до `max_blocks` штук).

#### Полная синхронизация
```http
POST /api/sync/full?batch_size=100
```

Запускает полную синхронизацию всех недостающих блоков.

#### Синхронизация мемпула
```http
POST /api/sync/mempool
```

Синхронизирует неподтвержденные транзакции из мемпула.

#### Проверка реорганизации
```http
POST /api/sync/check-reorg
```

Проверяет, произошла ли реорганизация блокчейна.

#### Обработка реорганизации
```http
POST /api/sync/handle-reorg?new_tip_hash=<hash>
```

Обрабатывает реорганизацию блокчейна.

#### Валидация базы данных
```http
GET /api/sync/validate
```

Проверяет целостность базы данных.

#### Статистика синхронизации
```http
GET /api/sync/stats
```

Возвращает детальную статистику синхронизации.

### 2. Фоновые задачи (`app/background.py`)

Автоматически запускаются при старте приложения:

- **Периодическая синхронизация блоков**: Каждые 60 секунд
  - Синхронизирует последние 10 блоков
  - Проверяет на реорганизации

- **Синхронизация мемпула**: Каждые 30 секунд
  - Синхронизирует неподтвержденные транзакции

- **Валидация БД**: Каждый час
  - Проверяет целостность данных
  - Логирует обнаруженные проблемы

### 3. Система кэширования (`app/cache.py`)

#### Основные возможности

- **In-memory кэш** с TTL (Time To Live)
- **Декораторы** для кэширования функций
- **Автоочистка** истекших записей

#### API Endpoints для кэша (`/api/cache`)

##### Статистика кэша
```http
GET /api/cache/stats
```

Возвращает:
```json
{
  "status": "success",
  "stats": {
    "total_entries": 100,
    "active_entries": 95,
    "expired_entries": 5
  }
}
```

##### Очистка кэша
```http
POST /api/cache/clear?prefix=blocks
```

Очищает кэш (опционально по префиксу).

##### Очистка истекших записей
```http
POST /api/cache/clear-expired
```

Удаляет все истекшие записи из кэша.

#### Использование в коде

```python
from app.cache import cached, cached_async, cache

# Синхронная функция
@cached(ttl=300, key_prefix="block")
def get_block_info(block_hash: str):
    # Код получения блока
    pass

# Асинхронная функция
@cached_async(ttl=300, key_prefix="tx")
async def get_transaction_info(txid: str):
    # Код получения транзакции
    pass

# Прямое использование кэша
cache.set("key", "value", ttl=300)
value = cache.get("key")
cache.delete("key")
cache.clear()
```

## Конфигурация

### Интервалы фоновых задач

Настроить в `app/background.py`:

```python
tasks = [
    asyncio.create_task(periodic_sync_task(interval=60)),      # Синхронизация
    asyncio.create_task(periodic_mempool_sync_task(interval=30)),  # Мемпул
    asyncio.create_task(periodic_validation_task(interval=3600)),  # Валидация
]
```

### TTL кэша

По умолчанию: 300 секунд (5 минут)

Настроить в `app/cache.py`:
```python
cache = SimpleCache(default_ttl=300)
```

## Мониторинг

### Health Check

```http
GET /health
```

Проверяет состояние приложения.

### Логирование

Все операции синхронизации логируются:
- Успешные синхронизации
- Ошибки
- Обнаруженные реорганизации
- Проблемы целостности БД

Пример логов:
```
INFO: Запущена периодическая синхронизация с интервалом 60с
INFO: Автосинхронизация: блоков=5, транзакций=250
WARNING: Обнаружена реорганизация блокчейна!
INFO: Валидация БД успешна
```

## Обработка реорганизаций

Система автоматически:
1. Обнаруживает реорганизации при периодической проверке
2. Находит общего предка
3. Удаляет орфанные блоки и транзакции
4. Логирует процесс

## Оптимизация производительности

### Кэширование
- Часто запрашиваемые блоки кэшируются
- Транзакции кэшируются с настраиваемым TTL
- Автоматическая очистка истекших записей

### Батч-обработка
- Синхронизация блоков батчами (по умолчанию 100)
- Минимизация запросов к Bitcoin RPC
- Оптимизация записи в БД

### Connection Pooling
- Переиспользование сессий БД
- Отдельные сессии для каждой background задачи

## Тестирование

### Запуск синхронизации вручную

```bash
# Синхронизация последних блоков
curl -X POST http://localhost:8000/api/sync/start?max_blocks=10

# Проверка статуса
curl http://localhost:8000/api/sync/status

# Статистика
curl http://localhost:8000/api/sync/stats
```

### Проверка кэша

```bash
# Статистика кэша
curl http://localhost:8000/api/cache/stats

# Очистка кэша
curl -X POST http://localhost:8000/api/cache/clear
```

## Troubleshooting

### Синхронизация не запускается

1. Проверьте подключение к Bitcoin Core:
   ```bash
   curl http://localhost:8000/api/sync/status
   ```

2. Проверьте логи приложения

3. Убедитесь, что не идет другая синхронизация:
   ```json
   "is_syncing": false
   ```

### Обнаружены проблемы целостности

Запустите валидацию:
```bash
curl http://localhost:8000/api/sync/validate
```

### Высокое использование памяти кэшем

Очистите кэш:
```bash
curl -X POST http://localhost:8000/api/cache/clear
```

Или настройте более короткий TTL в `app/cache.py`.

## Производительность

### Типичные показатели

- **Синхронизация блока**: ~100-500ms
- **Синхронизация транзакции**: ~50-200ms
- **Проверка реорганизации**: ~10-50ms
- **Cache hit**: ~1-5ms
- **Cache miss**: зависит от запроса

### Рекомендации

1. Используйте кэширование для часто запрашиваемых данных
2. Настройте оптимальные интервалы фоновых задач
3. Мониторьте логи на предмет ошибок
4. Периодически проверяйте целостность БД

## Дальнейшие улучшения

- [ ] Redis для распределенного кэша
- [ ] Prometheus metrics
- [ ] WebSocket для real-time уведомлений
- [ ] Автоматическое восстановление после сбоев
- [ ] Параллельная синхронизация блоков
- [ ] Приоритизация критичных блоков
